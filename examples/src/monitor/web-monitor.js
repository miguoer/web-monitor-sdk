function e(e){if(e&&e.__esModule)return e;var n=Object.create(null);return e&&Object.keys(e).forEach(function(t){if("default"!==t){var r=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(n,t,r.get?r:{enumerable:!0,get:function(){return e[t]}})}}),n.default=e,n}var n,t,r=window,o=document,i=r.navigator,a=r.performance,c=function(){var e;return null!=(e=i.deviceMemory)?e:0},l=function(){var e;return null!=(e=i.hardwareConcurrency)?e:0};!function(e){e[e.URGENT=1]="URGENT",e[e.IDLE=2]="IDLE"}(n||(n={})),function(e){e.NORMAL="NORMAL",e.PROMISE_ERROR="PROMISE_ERROR",e.WINDOW_RUNTIME_ERROR="WINDOW_RUNTIME_ERROR",e.RESOURCE_ERROR="RESOURCE_ERROR",e.PERFORMANCE_TIMING="PERFORMANCE_TIMING",e.PERFORMANCE_VITALS="PERFORMANCE_VITALS"}(t||(t={}));var s=function(){function e(e){var n=e.logUrl;if(!n)throw new Error("请传递要记录数据的路由~");this.logUrl=n}return e.prototype.sendToAnalytics=function(e,t,o,a){var c=this.logUrl;a&&(c=a),console.log("路由",c),console.log("typeof body",typeof t);var l={type:o,content:t};try{if(e==n.URGENT)if(r.fetch)fetch(c,{body:JSON.stringify(l),method:"POST",headers:{"Content-Type":"application/json"},keepalive:!0}).catch(function(){console.log("上报异常了")});else{var s=new XMLHttpRequest;s.open("post",c,!0),s.setRequestHeader("Content-Type","application/json"),s.send(JSON.stringify(l)),s.onload=function(e){s=null}}else if(e==n.IDLE)if(i.sendBeacon)navigator.sendBeacon(c,JSON.stringify(l));else{var u=new Image;u.src=c+"?body="+JSON.stringify(l),u.onload=function(){u=null}}}catch(e){console.log(e)}},e}(),u=function(e){console.log(e)},f={reportClient:new s({logUrl:"log"}),isResourceTiming:!1,isElementTiming:!1,maxTime:15e3},d=function(){return a&&!!a.getEntriesByType&&!!a.now&&!!a.mark},g="4g",m=!1,E=function(){return!!(l()&&l()<=4)||!!(c()&&c()<=4)},p=function(e,n){switch(e){case"slow-2g":case"2g":case"3g":return!0;default:return E()||n}},v={isHidden:!1},y=function(e){o.hidden&&(e&&e(),v.isHidden=o.hidden)},R=[1e3,2500],T=[2500,4e3],h=[100,300],O=[.1,.25],S=[300,600],b={fp:R,fcp:R,lcp:T,lcpFinal:T,fid:h,fidVitals:h,cls:O,clsFinal:O,tbt:S,tbt5S:S,tbt10S:S,tbtFinal:S},I=function(e,n){return b[e]?n<=b[e][0]?"good":n<=b[e][1]?"needsImprovement":"poor":null},w=function(e,o,a){var s;s=function(){if(!(v.isHidden&&e.indexOf("Final")<0)&&f.analyticsTracker){var r={metricName:e,data:o,eventProperties:a||{},navigatorInformation:i?{deviceMemory:c()||0,hardwareConcurrency:l()||0,serviceWorkerStatus:"serviceWorker"in i?i.serviceWorker.controller?"controlled":"supported":"unsupported",isLowEndDevice:E(),isLowEndExperience:p(g,m)}:{},vitalsScore:I(e,o)};f.reportClient.sendToAnalytics(n.IDLE,JSON.stringify(r),t.PERFORMANCE_TIMING),f.analyticsTracker(r)}},"requestIdleCallback"in r?r.requestIdleCallback(s,{timeout:3e3}):s()},C=function(e,n,t){Object.keys(n).forEach(function(e){"number"==typeof n[e]&&(n[e]=parseFloat(n[e].toFixed(2)))}),w(e,n,t)};function N(e,n){(null==n||n>e.length)&&(n=e.length);for(var t=0,r=new Array(n);t<n;t++)r[t]=e[t];return r}var L=function(){function e(){}var o=e.prototype;return o.globalUnCaughtError=function(){r.onerror=function(e,r,o,i,a){console.log("全局未捕获异常",e);var c=JSON.stringify({source:r,lineno:o,colno:i,error:a,message:e});return console.log("运行时错误",c),f.reportClient.sendToAnalytics(n.URGENT,c,t.WINDOW_RUNTIME_ERROR),!0}},o.resouceError=function(){r.addEventListener("error",function(e){e.target!==r&&(console.log("资源加载错误",e.target),f.reportClient.sendToAnalytics(n.IDLE,e.target.outerHTML,t.RESOURCE_ERROR))},!0)},o.promiseError=function(){r.addEventListener("unhandledrejection",function(e){console.log(e.reason),f.reportClient.sendToAnalytics(n.URGENT,e.reason+"",t.PROMISE_ERROR),e.preventDefault()},!0)},o.iframeError=function(){for(var e=r.frames,n=0;n<e.length;n++)e[n].addEventListener("error",function(e){console.log("addEventListener"),console.log(e)},!0),e[n].addEventListener("unhandledrejection",function(e){console.log("unhandledrejection")},!0)},o.run=function(){this.globalUnCaughtError(),this.resouceError(),this.promiseError()},e}();module.exports=function(){function n(e){void 0===e&&(e={});var n=e.logUrl;if(!n)throw new Error("Web系统系统监控平台，初始化未传递logUrl");var t=new s({logUrl:n});f.reportClient=t,this.reportClient=t,f.analyticsTracker=e.analyticsTracker||u,f.isResourceTiming=!!e.resourceTiming,f.isElementTiming=!!e.elementTiming,f.maxTime=e.maxMeasureTime||f.maxTime,e.captureError&&(new L).run(),this.initPerformance(e),void 0!==o.hidden&&o.addEventListener("visibilitychange",y.bind(this,null))}return n.prototype.initPerformance=function(n){var t;d()?(C("navigationTiming",function(){if(!d())return{};var e=a.getEntriesByType("navigation")[0];if(!e)return{};var n=e.responseStart,t=e.responseEnd;return{fetchTime:t-e.fetchStart,workerTime:e.workerStart>0?t-e.workerStart:0,totalTime:t-e.requestStart,downloadTime:t-n,timeToFirstByte:n-e.requestStart,headerSize:e.transferSize-e.encodedBodySize||0,dnsLookupTime:e.domainLookupEnd-e.domainLookupStart,tcpTime:e.connectEnd-e.connectStart||0,whiteTime:e.responseStart-e.navigationStart||0,domTime:e.domContentLoadedEventEnd-e.navigationStart||0,loadTime:e.loadEventEnd-e.navigationStart||0,parseDomTime:e.domComplete-e.domInteractive||0}}()),function(){if(d())for(var e,n=function(e,n){var t;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(t=function(e,n){if(e){if("string"==typeof e)return N(e,n);var t=Object.prototype.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?N(e,n):void 0}}(e))){t&&(e=t);var r=0;return function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}return(t=e[Symbol.iterator]()).next.bind(t)}(performance.getEntriesByType("resource"));!(e=n()).done;)C("resourceTiming",e.value)}(),C("networkInformation",function(){if("connection"in i){var e=i.connection;return"object"!=typeof e?{}:(g=e.effectiveType,m=!!e.saveData,{downlink:e.downlink,effectiveType:e.effectiveType,rtt:e.rtt,saveData:!!e.saveData})}return{}}()),(t=function(e){w(e.name.toLocaleLowerCase(),e.value)})&&t instanceof Function&&Promise.resolve().then(function(){return e(require("web-vitals"))}).then(function(e){var n=e.getFID,r=e.getFCP,o=e.getLCP,i=e.getTTFB;(0,e.getCLS)(t),n(t),r(t),o(t),i(t)})):console.log("浏览器不支持性能指标")},n}();
//# sourceMappingURL=web-monitor.js.map
